<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To Do</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body onload="carregarTarefas()">
    <h1>Tarefas</h1>
    <form action="">
        <input type="text" name="novatarefa" placeholder="Nova tarefa">
        <input type="submit" value="Inserir">
    </form>

    <div id="lista"></div>

    <script>
        let request = indexedDB.open("listaTarefas", 1);
        request.onerror = console.error;
        let db;
        request.onsuccess = () => {
            db = request.result;
        }
        request.onupgradeneeded = (evento) => { 
            db = evento.target.result;
            db.createObjectStore("tarefas", {autoIncrement: true});
        }

        function carregarTarefas() {
            let tarefas = db.transaction(["tarefas"]).objectStore("tarefas");
            tarefas.openCursor().onsuccess = evento => {
                let cursor = evento.target.result;
                if (cursor) {
                    const tarefa = novaTarefa(cursor.value.texto);
                    tarefa.setAttribute('id', cursor.key);
                    if (cursor.value.feito) {
                        tarefa.firstElementChild.click();
                    }
                    document.querySelector("#lista").append(tarefa);
                    cursor.continue();
                }
            }
        }

        const formulario = document.querySelector("form");
        formulario.addEventListener("submit", insereTarefa);
        function insereTarefa(evento) {
            evento.preventDefault();
            const formulario = evento.target;
            const input = formulario.querySelector("input[type=text]");
            const texto = input.value;
            if (texto == "") return;
            input.value = "";
            input.focus();
            const lista = document.querySelector("#lista");
            const tarefa = novaTarefa(texto);
            lista.append(tarefa);
            // adiciona no banco de dados
            let req = db.transaction(["tarefas"], "readwrite")
                        .objectStore("tarefas")
                        .put({'texto': texto, 'feito': false});
            req.onsuccess = evento => {
                tarefa.setAttribute('id', evento.target.result);
            }
        }
        function novaTarefa(texto) {
            const tarefa = document.createElement('p');
            const checkbox = document.createElement('input');
            checkbox.setAttribute('type', 'checkbox');
            // checkbox.addEventListener('click', eventoCheckbox => {
            //     if (eventoCheckbox.target.checked) {
            //         let req = db.transaction(["tarefas"], "readwrite")
            //             .objectStore("tarefas")
            //             .get(parseInt(eventoCheckbox.target.parentNode.id));
            //         req.onsuccess = eventoReq => {
            //             let registro = eventoReq.target.result;
            //             registro['feito'] = true;
            //             db.transaction(["tarefas"], "readwrite")
            //             .objectStore("tarefas")
            //             .put(registro);
            //         }
            //     }
            // });
            tarefa.append(checkbox);
            tarefa.append(texto + ' ');
            const lixeira = document.createElement('span');
            lixeira.classList.add('fa');
            lixeira.classList.add('fa-trash-o');
            lixeira.addEventListener('click', removeTarefa);
            tarefa.append(lixeira);
            return tarefa;
        }
        function removeTarefa(evento) {
            const lixeira = evento.target;
            const tarefa = lixeira.parentNode;
            tarefa.remove();
            // remove do banco de dados
            db.transaction(["tarefas"], "readwrite")
            .objectStore("tarefas")
            .delete(parseInt(tarefa.id));
        }
    </script>
</body>
</html>